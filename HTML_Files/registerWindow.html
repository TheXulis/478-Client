<!DOCTYPE html>
<html lang="en">
<head>
   
    <title>Register as New User</title>
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">  -->
</head>
<body>
<!--    <nav>
        <div class="nav-wrapper">
            <a href="" class="brand-logo center">Register</a>
        </div>
    </nav>
-->

    <form>
        <div>
            <label>Select Username</label>
        </div>
        <div>
            <input type ="text" id = "name" autofocus>
        </div> 
        <div>   
            <label>Select Password</label>
            
        </div>
        <div>
            <input type ="password" id = "password" >
        </div>

        <button type = "submit">Register!</button>
    </form>

    <script>
            const electron = require('electron');
            const {ipcRenderer} = electron;
            const https = require("https");
            const queryString = require("querystring");
            const fs = require("fs");
            const path = require('path');
            const form = document.querySelector('form');
            form.addEventListener('submit', submitForm);
    
            function submitForm(e){
                e.preventDefault();
                const username = document.querySelector('#name').value;
                const pw = document.querySelector('#password').value;
                const user = {'name':name, 'password':password};
                


                const body = queryString.stringify({ name:username ,password:pw });

                const options = {
                host: 'end2endchat.me',
                port: 3000,
                path: '/register',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                
            };
            
            // send Post register
            let req = https.request(options, function(res){
                res.on('end', function(){
                    //console.log("attempt");
                })
                res.on('data', function(chunk){
                    let {message} = JSON.parse(chunk);
                    if(message == "Worked"){
                        const PythonShell = require('python-shell');

                        PythonShell.run('Encryption/keygen.py', function(err, results){
                            
                            let absoluteKeyPath = path.resolve('../keys/publicChatKey.pem');
                            let pubKey = fs.readFileSync(absoluteKeyPath, 'utf8');
                            console.log(pubKey);

                            const options2 = {
                                host: 'end2endchat.me',
                                port: 3000,
                                path: '/pubKey',
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                }
                            };

                            let req2 = https.request(options2, function(res){
                                res.on('end', function(){
                                    console.log("pubKey end");
                                });

                                res.on('data', function(chunk1){
                                    let {user} = JSON.parse(chunk1);
                                    console.log(user);
                                });
                            });

                            const body2 = queryString.stringify({ name:username , publickey:pubKey});

                            req2.write(body2);
                            req2.end();

                            ipcRenderer.send('register:user');
                        });

                        
                    } else{
                        location.reload();
                    }
                   // console.log(chunk.toString('utf8'));
                });
            });
            
                req.write(body);
                req.end();

            }

            
          
        </script>

   
    
</body>
</html>